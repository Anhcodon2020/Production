{% extends "base.html" %}

{% block title %}Quản lý Sản Lượng{% endblock %}

{% block content %}
<style>
    .table-container { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #f8f9fa; font-weight: bold; color: #333; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 600px; border-radius: 8px; position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    
    .btn-save { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
    .btn-edit { background-color: #ffc107; color: black; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-delete { background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }
    
    .pagination { display: flex; justify-content: center; margin-top: 20px; list-style: none; padding: 0; }
    .pagination a, .pagination span { padding: 8px 16px; text-decoration: none; border: 1px solid #ddd; color: #333; margin: 0 4px; border-radius: 4px; }
    .pagination .active { background-color: #2c3e50; color: white; border: 1px solid #2c3e50; }
    .pagination .disabled { color: #ccc; pointer-events: none; border-color: #eee; }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}" style="padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; color: #155724; background-color: #d4edda; border-color: #c3e6cb;">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="box" style="width: 95%; max-width: 1400px; margin: 0 auto;">
    <h1>Quản lý & Sửa Sản Lượng (Admin)</h1>

    <!-- Search Form -->
    <div class="search-container" style="margin-top: 20px; text-align: left;">
        <form method="GET" action="{{ url_for('manage_productivity') }}" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <div>
                <label style="font-weight: bold;">Từ ngày:</label>
                <input type="date" name="from_date" value="{{ from_date or '' }}" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            </div>
            <div>
                <label style="font-weight: bold;">Đến ngày:</label>
                <input type="date" name="to_date" value="{{ to_date or '' }}" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            </div>
            <input type="text" name="search" placeholder="Tìm theo Số Cont, Task, Account..." value="{{ search_term or '' }}" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            <button type="submit" style="padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: white; cursor: pointer;">Tìm kiếm</button>
            <a href="{{ url_for('manage_productivity') }}" style="padding: 8px 15px; text-decoration: none; background-color: #6c757d; color: white; border-radius: 4px;">Xóa tìm</a>
        </form>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ngày</th>
                    <th>Số Cont/Xe</th>
                    <th>Khách hàng</th>
                    <th>Account</th>
                    <th>Task</th>
                    <th>CBM (Gốc)</th>
                    <th>Sản lượng (Quy đổi)</th>
                    <th>Đơn vị</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                {% if records and records.items %}
                {% for item in records.items %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.work_date.strftime('%d/%m/%Y') if item.work_date else '' }}</td>
                    <td>{{ item.ref_no }}</td>
                    <td>{{ item.customer_id }}</td>
                    <td>{{ item.account_id }}</td>
                    <td>{{ item.task_id }}</td>
                    <td>{{ item.productivity_value }}</td>
                    <td style="font-weight: bold; color: #0056b3;">{{ "{:,.2f}".format(item.quantity) if item.quantity else 0 }}</td>
                    <td>{{ item.unit }}</td>
                    <td>
                        <button class="btn-edit" 
                                data-id="{{ item.id }}"
                                data-date="{{ item.work_date }}"
                                data-ref="{{ item.ref_no }}"
                                data-cust="{{ item.customer_id }}"
                                data-acc="{{ item.account_id }}"
                                data-task="{{ item.task_id }}"
                                data-cbm="{{ item.productivity_value }}"
                                data-qty="{{ item.quantity }}"
                                data-unit="{{ item.unit }}"
                                onclick="openEditModal(this)">Sửa</button>
                        <form action="{{ url_for('delete_productivity', id=item.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Bạn có chắc chắn muốn xóa dòng này?');">
                            <button type="submit" class="btn-delete">Xóa</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="10" style="text-align: center; padding: 20px;">Không tìm thấy dữ liệu.</td></tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if records and records.pages > 1 %}
        <div class="pagination">
            {% for page_num in records.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if records.page == page_num %}
                        <span class="active">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ url_for('manage_productivity', page=page_num, search=search_term, from_date=from_date, to_date=to_date) }}">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                    <span class="disabled">...</span>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Sửa -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
    <h2 style="margin-top: 0; text-align: center;">Sửa Sản Lượng</h2>
    <form id="editForm" method="POST" action="">
      <div class="form-group"><label>Ngày làm việc</label><input type="date" name="work_date" required></div>
      <div class="form-group"><label>Số Cont/Xe</label><input type="text" name="ref_no"></div>
      <div class="form-group"><label>Khách hàng</label><input type="text" name="customer_id" readonly></div>
      <div class="form-group"><label>Account</label><input type="text" name="account_id" readonly></div>
      <div class="form-group">
        <label>Task</label>
        <select id="taskSelectInModal" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"></select>
        <input type="hidden" name="task_id" id="taskNameHidden">
      </div>
      <div class="form-group"><label>CBM (Giá trị gốc)</label><input type="number" step="0.01" name="productivity_value"></div>
      <div class="form-group"><label>Sản lượng (Sau quy đổi)</label><input type="number" step="0.01" name="quantity" required></div>
      <div class="form-group"><label>Đơn vị tính</label><input type="text" name="unit"></div>
      <button type="submit" class="btn-save">Cập nhật</button>
    </form>
  </div>
</div>

<script>
    const editModal = document.getElementById('editModal');
    const cbmInput = editModal.querySelector('[name="productivity_value"]');
    const taskSelect = editModal.querySelector('#taskSelectInModal');
    const quantityInput = editModal.querySelector('[name="quantity"]');
    const unitInput = editModal.querySelector('[name="unit"]');
    const customerInput = editModal.querySelector('[name="customer_id"]');
    const accountInput = editModal.querySelector('[name="account_id"]');
    const taskNameHidden = editModal.querySelector('#taskNameHidden');

    async function recalculateQuantity() {
        const cbm = parseFloat(cbmInput.value) || 0;
        const customerName = customerInput.value;
        const accountName = accountInput.value;
        const taskName = taskSelect.value;

        if(taskName) {
            taskNameHidden.value = taskName;
        }

        try {
            const url = `/api/get-conversion-info?customer_name=${encodeURIComponent(customerName)}&account_name=${encodeURIComponent(accountName)}&task_name=${encodeURIComponent(taskName)}`;
            const response = await fetch(url);
            const data = await response.json();
            
            const conversionIndex = data.conversion_index || 1.0;
            const unit = data.unit || 'CBM';

            const newQuantity = cbm * conversionIndex;
            quantityInput.value = newQuantity.toFixed(2);
            unitInput.value = unit;

        } catch (error) {
            console.error("Error recalculating:", error);
            quantityInput.value = cbm.toFixed(2);
            unitInput.value = 'CBM';
        }
    }

    async function loadTasksForModal(customerName, accountName, selectedTaskName) {
        taskSelect.innerHTML = '<option>Đang tải...</option>';
        try {
            const url = `/api/tasks-by-account-name?customer_name=${encodeURIComponent(customerName)}&account_name=${encodeURIComponent(accountName)}`;
            const response = await fetch(url);
            const tasks = await response.json();

            taskSelect.innerHTML = '';
            if (tasks.length === 0) {
                taskSelect.innerHTML = '<option value="">-- Không có task --</option>';
            }

            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.name;
                option.textContent = task.name;
                if (task.name === selectedTaskName) {
                    option.selected = true;
                }
                taskSelect.appendChild(option);
            });
            
            await recalculateQuantity();

        } catch (error) {
            console.error("Error loading tasks:", error);
            taskSelect.innerHTML = '<option value="">Lỗi tải task</option>';
        }
    }

    cbmInput.addEventListener('input', recalculateQuantity);
    taskSelect.addEventListener('change', recalculateQuantity);

    function openEditModal(btn) {
        var modal = document.getElementById('editModal');
        var form = document.getElementById('editForm');
        form.action = "/productivity/edit/" + btn.getAttribute('data-id');
        
        form.querySelector('[name="work_date"]').value = btn.getAttribute('data-date');
        form.querySelector('[name="ref_no"]').value = btn.getAttribute('data-ref');
        form.querySelector('[name="productivity_value"]').value = btn.getAttribute('data-cbm');

        const customerName = btn.getAttribute('data-cust');
        const accountName = btn.getAttribute('data-acc');
        const taskName = btn.getAttribute('data-task');

        form.querySelector('[name="customer_id"]').value = customerName;
        form.querySelector('[name="account_id"]').value = accountName;
        
        loadTasksForModal(customerName, accountName, taskName);
        
        modal.style.display = "block";
    }
    window.onclick = function(event) { if (event.target == document.getElementById('editModal')) { document.getElementById('editModal').style.display = "none"; } }
</script>
{% endblock %}