{% extends "base.html" %}

{% block title %}Import D·ªØ Li·ªáu{% endblock %}

{% block content %}
<style>
    /* General Layout */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .page-title {
        margin: 0;
        color: #2c3e50;
        font-size: 24px;
    }
    
    /* Cards */
    .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #eaeaea;
    }
    .card-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
        font-weight: 600;
        font-size: 18px;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Upload Section */
    .upload-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .upload-zone:hover {
        border-color: #3498db;
        background-color: #f1f8ff;
    }
    .upload-icon {
        font-size: 48px;
        color: #a0aec0;
        margin-bottom: 15px;
    }
    .upload-text {
        color: #4a5568;
        font-size: 16px;
        margin-bottom: 5px;
    }
    .upload-subtext {
        color: #718096;
        font-size: 14px;
    }
    #fileInput {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
    .btn-primary { background-color: #3498db; color: white; }
    .btn-primary:hover { background-color: #2980b9; }
    .btn-success { background-color: #2ecc71; color: white; }
    .btn-success:hover { background-color: #27ae60; }
    .btn-danger { background-color: #e74c3c; color: white; }
    .btn-danger:hover { background-color: #c0392b; }
    .btn-warning { background-color: #f1c40f; color: #333; }
    .btn-warning:hover { background-color: #d4ac0d; }
    .btn-outline { background-color: transparent; border: 1px solid #cbd5e0; color: #4a5568; }
    .btn-outline:hover { background-color: #f7fafc; border-color: #a0aec0; }

    /* Progress Bar */
    .progress-wrapper {
        margin-top: 20px;
        display: none;
    }
    .progress {
        height: 10px;
        background-color: #e2e8f0;
        border-radius: 5px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background-color: #3498db;
        width: 0%;
        transition: width 0.3s ease;
    }
    .progress-text {
        text-align: center;
        font-size: 13px;
        color: #718096;
        margin-top: 5px;
    }

    /* Tables */
    .table-responsive {
        overflow-x: auto;
        border-radius: 6px;
        border: 1px solid #eaeaea;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    th {
        background-color: #f8f9fa;
        color: #4a5568;
        font-weight: 600;
        padding: 12px 15px;
        text-align: left;
        border-bottom: 2px solid #eaeaea;
        white-space: nowrap;
    }
    td {
        padding: 12px 15px;
        border-bottom: 1px solid #eaeaea;
        color: #2d3748;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: #f8fafc; }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-error { background-color: #fed7d7; color: #c53030; }
    .status-ok { background-color: #c6f6d5; color: #2f855a; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 0; border-radius: 8px; width: 700px; max-width: 95%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: slideIn 0.3s ease; }
    .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { margin: 0; font-size: 18px; font-weight: 600; }
    .modal-body { padding: 20px; }
    .close { font-size: 24px; color: #a0aec0; cursor: pointer; }
    .close:hover { color: #4a5568; }
    
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 13px; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px; transition: border-color 0.2s; box-sizing: border-box; }
    .form-control:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div style="width: 95%; max-width: 1200px; margin: 0 auto;">
    
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">Import D·ªØ Li·ªáu</h1>
        <a href="{{ url_for('download_template') }}" class="btn btn-outline">
            <i class="fa fa-download"></i> T·∫£i Template M·∫´u
        </a>
    </div>

    <!-- Upload Section -->
    <div class="card">
        <div class="card-header">
            <span>Upload File Excel</span>
        </div>
        <form id="uploadForm" method="POST" action="{{ url_for('import_data') }}" enctype="multipart/form-data">
            <div class="upload-zone" id="dropZone">
                <input type="file" name="file" id="fileInput" accept=".xlsx, .xls" required>
                <div class="upload-icon">üìÇ</div>
                <div class="upload-text">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</div>
                <div class="upload-subtext" id="fileName">Ch·ªâ ch·∫•p nh·∫≠n file .xlsx, .xls</div>
            </div>
            
            <div class="progress-wrapper" id="progressWrapper">
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">ƒêang t·∫£i l√™n 0%</div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" id="btnUpload">
                    <i class="fa fa-cloud-upload"></i> Upload & Import
                </button>
            </div>
        </form>
    </div>

    <!-- Preview Section (Only shows if data exists) -->
    {% if preview_data %}
    <div class="card" style="border-left: 4px solid {{ '#e74c3c' if has_errors else '#2ecc71' }};">
        <div class="card-header">
            <span style="color: {{ '#e74c3c' if has_errors else '#2ecc71' }};">
                {{ '‚ö†Ô∏è Ph√°t hi·ªán l·ªói d·ªØ li·ªáu' if has_errors else '‚úÖ D·ªØ li·ªáu h·ª£p l·ªá' }}
            </span>
            <div>
                <form id="confirmImportForm" action="{{ url_for('confirm_import') }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-success" {% if has_errors %}disabled style="opacity: 0.6; cursor: not-allowed;" title="Vui l√≤ng s·ª≠a l·ªói tr∆∞·ªõc"{% endif %}>
                        L∆∞u Ch√≠nh Th·ª©c
                    </button>
                </form>
                <form action="{{ url_for('cancel_import') }}" method="POST" style="display: inline; margin-left: 10px;">
                    <button type="submit" class="btn btn-danger">H·ªßy B·ªè</button>
                </form>
            </div>
        </div>
        
        {% if has_errors %}
        <div style="background-color: #fff5f5; color: #c53030; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;">
            <strong>L∆∞u √Ω:</strong> C√°c d√≤ng m√†u ƒë·ªè ch·ª©a th√¥ng tin kh√¥ng h·ª£p l·ªá (Kh√°ch h√†ng ho·∫∑c Account kh√¥ng t·ªìn t·∫°i). Vui l√≤ng ch·ªânh s·ª≠a ho·∫∑c x√≥a tr∆∞·ªõc khi l∆∞u.
        </div>
        {% endif %}

        <div class="table-responsive" style="max-height: 500px;">
            <table>
                <thead>
                    <tr>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Date</th>
                        <th>S·ªë Cont/Xe</th>
                        <th>CBM</th>
                        <th>Task</th>
                        <th>Account</th>
                        <th>Kh√°ch H√†ng</th>
                        <th>Nh√¢n s·ª±</th>
                        <th style="text-align: center;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in preview_data %}
                    <tr style="{{ 'background-color: #fff5f5;' if not item.is_valid else '' }}">
                        <td>
                            {% if item.is_valid %}
                                <span class="status-badge status-ok">OK</span>
                            {% else %}
                                <span class="status-badge status-error">L·ªói</span>
                            {% endif %}
                        </td>
                        <td>{{ item.record.date.strftime('%d/%m/%Y') if item.record.date else '' }}</td>
                        <td>{{ item.record.container_no }}</td>
                        <td>{{ item.record.cbm }}</td>
                        <td>{{ item.record.task }}</td>
                        <td>{{ item.record.account }}</td>
                        <td>{{ item.record.customer }}</td>
                        <td>
                            <small style="color: #718096;">
                                {{ [item.record.tally, item.record.lift_truck] | select("ne", None) | join(", ") }}
                                {% if item.record.worker_1 %}...{% endif %}
                            </small>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;"
                                data-id="{{ item.record.id }}"
                                data-date="{{ item.record.date }}"
                                data-container="{{ item.record.container_no }}"
                                data-cbm="{{ item.record.cbm }}"
                                data-tally="{{ item.record.tally }}"
                                data-lift="{{ item.record.lift_truck }}"
                                data-w1="{{ item.record.worker_1 }}" data-w2="{{ item.record.worker_2 }}"
                                data-w3="{{ item.record.worker_3 }}" data-w4="{{ item.record.worker_4 }}"
                                data-w5="{{ item.record.worker_5 }}" data-w6="{{ item.record.worker_6 }}"
                                data-task="{{ item.record.task }}"
                                data-account="{{ item.record.account }}"
                                data-customer="{{ item.record.customer }}"
                                onclick="openEditTempModal(this)">S·ª≠a</button>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="confirmDeleteTemp('{{ item.record.id }}')">X√≥a</button>
                            <form id="delete-temp-{{ item.record.id }}" action="{{ url_for('delete_temp_data', id=item.record.id) }}" method="POST" style="display: none;"></form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- History Section -->
    <div class="card">
        <div class="card-header">
            <span>L·ªãch s·ª≠ Import (G·∫ßn ƒë√¢y)</span>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ng√†y l√†m vi·ªác</th>
                        <th>S·ªë Cont/Xe</th>
                        <th>S·∫£n l∆∞·ª£ng</th>
                        <th>Task</th>
                        <th>Account</th>
                        <th>Kh√°ch h√†ng</th>
                    </tr>
                </thead>
                <tbody>
                    {% if records and records.items %}
                        {% for item in records.items %}
                        <tr>
                            <td>{{ item.id }}</td>
                            <td>{{ item.work_date.strftime('%d/%m/%Y') if item.work_date else '' }}</td>
                            <td>{{ item.ref_no }}</td>
                            <td>{{ "{:,.2f}".format(item.quantity) if item.quantity else 0 }} {{ item.unit }}</td>
                            <td>{{ item.task_id }}</td>
                            <td>{{ item.account_id }}</td>
                            <td>{{ item.customer_id }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7" style="text-align: center; padding: 30px; color: #718096;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c import.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if records and records.pages > 1 %}
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 5px;">
            {% for page_num in records.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    <a href="{{ url_for('import_data', page=page_num) }}" 
                       class="btn {{ 'btn-primary' if page_num == records.page else 'btn-outline' }}"
                       style="padding: 5px 12px;">{{ page_num }}</a>
                {% else %}
                    <span style="padding: 5px;">...</span>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div id="editTempModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Ch·ªânh S·ª≠a D·ªØ Li·ªáu</h3>
            <span class="close" onclick="document.getElementById('editTempModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editTempForm" method="POST" action="">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ng√†y l√†m vi·ªác</label>
                        <input type="date" name="date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>S·ªë Cont/Xe</label>
                        <input type="text" name="container_no" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Kh√°ch H√†ng</label>
                        <input type="text" name="customer" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Account</label>
                        <input type="text" name="account" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Task</label>
                        <input type="text" name="task" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>CBM</label>
                        <input type="number" step="0.01" name="cbm" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tally</label>
                        <input type="text" name="tally" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Xe N√¢ng</label>
                        <input type="text" name="lift_truck" class="form-control">
                    </div>
                </div>
                
                <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <label style="font-weight: 600; font-size: 13px; color: #333; display: block; margin-bottom: 10px;">Nh√¢n s·ª± kh√°c (C√¥ng nh√¢n)</label>
                    <div class="form-grid">
                        <div class="form-group"><input type="text" name="worker_1" class="form-control" placeholder="C√¥ng nh√¢n 1"></div>
                        <div class="form-group"><input type="text" name="worker_2" class="form-control" placeholder="C√¥ng nh√¢n 2"></div>
                        <div class="form-group"><input type="text" name="worker_3" class="form-control" placeholder="C√¥ng nh√¢n 3"></div>
                        <div class="form-group"><input type="text" name="worker_4" class="form-control" placeholder="C√¥ng nh√¢n 4"></div>
                        <div class="form-group"><input type="text" name="worker_5" class="form-control" placeholder="C√¥ng nh√¢n 5"></div>
                        <div class="form-group"><input type="text" name="worker_6" class="form-control" placeholder="C√¥ng nh√¢n 6"></div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('editTempModal').style.display='none'">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">C·∫≠p Nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div style="font-size: 16px; font-weight: 600; color: #2c3e50;">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>
</div>

<!-- Th√™m th∆∞ vi·ªán SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // SweetAlert Toast for Flash Messages
    document.addEventListener('DOMContentLoaded', function() {
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: '{{ "error" if category == "danger" else category }}',
                    title: '{{ message }}',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            {% endfor %}
        {% endif %}
        {% endwith %}
    });

    // File Input Handling
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    
    fileInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
            fileNameDisplay.textContent = "ƒê√£ ch·ªçn: " + this.files[0].name;
            fileNameDisplay.style.color = "#2ecc71";
            fileNameDisplay.style.fontWeight = "bold";
        } else {
            fileNameDisplay.textContent = "Ch·ªâ ch·∫•p nh·∫≠n file .xlsx, .xls";
            fileNameDisplay.style.color = "#718096";
            fileNameDisplay.style.fontWeight = "normal";
        }
    });

    // Modal Logic
    window.onclick = function(event) {
        if (event.target == document.getElementById('editTempModal')) {
            document.getElementById('editTempModal').style.display = "none";
        }
    }

    function openEditTempModal(btn) {
        var modal = document.getElementById('editTempModal');
        var form = document.getElementById('editTempForm');
        
        form.action = "/import-data/update-temp/" + btn.getAttribute('data-id');
        
        // Populate fields
        const fields = ['date', 'container_no', 'cbm', 'tally', 'lift_truck', 'task', 'account', 'customer', 'worker_1', 'worker_2', 'worker_3', 'worker_4', 'worker_5', 'worker_6'];
        
        // Map data attributes to form inputs
        form.querySelector('[name="date"]').value = btn.getAttribute('data-date');
        form.querySelector('[name="container_no"]').value = btn.getAttribute('data-container');
        form.querySelector('[name="cbm"]').value = btn.getAttribute('data-cbm');
        form.querySelector('[name="tally"]').value = btn.getAttribute('data-tally');
        form.querySelector('[name="lift_truck"]').value = btn.getAttribute('data-lift');
        form.querySelector('[name="task"]').value = btn.getAttribute('data-task');
        form.querySelector('[name="account"]').value = btn.getAttribute('data-account');
        form.querySelector('[name="customer"]').value = btn.getAttribute('data-customer');
        
        form.querySelector('[name="worker_1"]').value = btn.getAttribute('data-w1');
        form.querySelector('[name="worker_2"]').value = btn.getAttribute('data-w2');
        form.querySelector('[name="worker_3"]').value = btn.getAttribute('data-w3');
        form.querySelector('[name="worker_4"]').value = btn.getAttribute('data-w4');
        form.querySelector('[name="worker_5"]').value = btn.getAttribute('data-w5');
        form.querySelector('[name="worker_6"]').value = btn.getAttribute('data-w6');
        
        modal.style.display = "block";
    }

    function confirmDeleteTemp(id) {
        Swal.fire({
            title: 'X√≥a d√≤ng n√†y?',
            text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng d·ªØ li·ªáu t·∫°m n√†y?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#718096',
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-temp-' + id).submit();
            }
        });
    }

    // Loading Overlay for Confirm
    var confirmForm = document.getElementById('confirmImportForm');
    if (confirmForm) {
        confirmForm.addEventListener('submit', function() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        });
    }

    // AJAX Upload with Progress
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var form = this;
        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();
        
        var progressBar = document.getElementById('progressBar');
        var progressText = document.getElementById('progressText');
        var progressWrapper = document.getElementById('progressWrapper');
        var btnUpload = document.getElementById('btnUpload');

        progressWrapper.style.display = 'block';
        btnUpload.disabled = true;
        btnUpload.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...';
        progressBar.style.width = '0%';
        progressBar.style.backgroundColor = '#3498db';

        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                var percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.innerText = 'ƒêang t·∫£i l√™n ' + Math.round(percentComplete) + '%';
                
                if (percentComplete >= 100) {
                    btnUpload.innerHTML = '<i class="fa fa-cog fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                    progressText.innerText = 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...';
                    progressBar.style.backgroundColor = '#2ecc71';
                    document.getElementById('loadingOverlay').style.display = 'flex';
                }
            }
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                document.open();
                document.write(xhr.responseText);
                document.close();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'C√≥ l·ªói x·∫£y ra',
                    text: 'M√£ l·ªói: ' + xhr.status
                });
                resetUploadState();
            }
        };

        xhr.onerror = function() {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói k·∫øt n·ªëi',
                text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.'
            });
            resetUploadState();
        };

        xhr.open('POST', form.action, true);
        xhr.send(formData);
    });

    function resetUploadState() {
        var btnUpload = document.getElementById('btnUpload');
        var progressWrapper = document.getElementById('progressWrapper');
        
        btnUpload.disabled = false;
        btnUpload.innerHTML = '<i class="fa fa-cloud-upload"></i> Upload & Import';
        progressWrapper.style.display = 'none';
        document.getElementById('loadingOverlay').style.display = 'none';
    }
</script>
{% endblock %}